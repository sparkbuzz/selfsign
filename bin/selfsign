#!/usr/bin/env bash
SCRIPT_PATH="$( cd "$(dirname "$0")" ; pwd -P )"
source ${SCRIPT_PATH}/../config.bash

if [ $# -ne 1 ]; then
  echo 'Usage: ./selfsign <domain>';
  exit 0;
fi

# Generate a RSA private key to sign the certificate with
echo "⦿ Generating RSA private key"
openssl genrsa \
  -out ${OUT_PATH}/$1.key \
  512 \
    > /dev/null 2>&1

echo "⦿ Generating Certificate Signing Request";
openssl req \
  -new \
  -key ${OUT_PATH}/$1.key \
  -out ${OUT_PATH}/$1.csr \
  -subj "/C=${COUNTRY_CODE}/ST=${STATE}/L=${LOCALITY}/O=${COMPANY}/CN=${COMMON_NAME}" \
    > /dev/null 2>&1

# Generate certificate
echo "⦿ Generating certificate"
openssl req \
  -newkey rsa:2048 \
  -x509 \
  -nodes \
  -keyout ${OUT_PATH}/$1.key \
  -new \
  -out ${OUT_PATH}/$1.cer \
  -subj "/C=${COUNTRY_CODE}/ST=${STATE}/L=${LOCALITY}/O={COMPANY}/CN=${COMMON_NAME}" \
  -reqexts SAN \
  -extensions SAN \
  -config \
    <(cat /etc/ssl/openssl.cnf \
    <(printf "[SAN]\nsubjectAltName=DNS:${COMMON_NAME} ")) \
  -sha256 \
  -days 365 \
    > /dev/null 2>&1

echo "Done!"