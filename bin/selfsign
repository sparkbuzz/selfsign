#!/usr/bin/env bash
source ./config.bash

if [ $# -ne 1 ]; then
  echo 'Usage: ./selfsign <domain>';
  exit 0;
fi

# Generate a RSA private key to sign the certificate with
openssl genrsa -out /tmp/$1.key 1024

# Generate a certificate signing request
openssl req -new -key /tmp/$1.key -out /tmp/$1.csr -subj "/C=${country_code}/ST=${state}/L=${locality}/O=${company}/CN=${common_name}"

# Generate certificate
openssl req \
  -newkey rsa:2048 \
  -x509 \
  -nodes \
  -keyout /tmp/$1.key \
  -new \
  -out /tmp/$1.cer \
  -subj "/C=${country_code}/ST=${state}/L=${locality}/O={company}/CN=${common_name}" \
  -reqexts SAN \
  -extensions SAN \
  -config \
    <(cat /etc/ssl/openssl.cnf \
    <(printf "[SAN]\nsubjectAltName=DNS:${common_name} ")) \
  -sha256 \
  -days 365
