#!/usr/bin/env sh

# Resolve path to this script, even if executed via a symlink
if [ $(uname) = 'Darwin' ]; then
  SCRIPT_PATH="$(dirname "$(readlink "$0")")" # MacOS
else
  SCRIPT_PATH="$(dirname "$(readlink -f "$0")")" # Linux etc.
fi

source $SCRIPT_PATH/../config/color.sh
source $SCRIPT_PATH/../config/ssl.sh
source $SCRIPT_PATH/../lib/functions.sh

# Show usage info when no arguments are set
[ $# -ne 1 ] && usage

DOMAIN=$1

mkdir -p "${PWD}/${DOMAIN}"

# Generate RSA key -> CSR -> Certificate
generate_rsa_key $PWD $DOMAIN
generate_csr $PWD $DOMAIN
generate_certificate $PWD $DOMAIN

# Output certificate info
certificate_info $PWD/$DOMAIN/cert.pem
list_permissions "$PWD/$DOMAIN/cert.csr $PWD/$DOMAIN/cert.pem $PWD/$DOMAIN/privkey.pem"

echo "Certificate generated!"
