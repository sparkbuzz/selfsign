#!/usr/bin/env sh

# Resolve path to the this script, even if executed via a symlink
if [ $(uname) = 'Darwin' ]; then
  SCRIPT_PATH="$(dirname "$(readlink "$0")")" # MacOS
else
  SCRIPT_PATH="$(dirname "$(readlink -f "$0")")" # Linux etc.
fi

source ${SCRIPT_PATH}/../config/color.sh
source ${SCRIPT_PATH}/../config/ssl.sh

if [ $# -ne 1 ]; then
  echo 'Usage: ./selfsign <common_name>';
  exit 0;
fi

COMMON_NAME="${1}.localhost"
OUT_PATH=${PWD}

# Generate a RSA private key to sign the certificate with
echo -ne "${WHITE}‚¶ø${NC} Generating RSA private key "
openssl genrsa \
  -out ${OUT_PATH}/$1.key \
  1024 \
    > /dev/null 2>&1

if [ ! -f "$OUT_PATH/$1.key" ]; then
  echo -e "${RED}‚úó${NC}"
  exit 1
else
  echo -e "${GREEN}‚úì${NC}"
fi

echo -ne "${WHITE}‚¶ø${NC} Generating Certificate Signing Request ";
openssl req \
  -new \
  -key ${OUT_PATH}/$1.key \
  -out ${OUT_PATH}/$1.csr \
  -subj "/C=${COUNTRY_CODE}/ST=${STATE}/L=${LOCALITY}/O=${COMPANY}/CN=${COMMON_NAME}" \
    > /dev/null 2>&1

if [ ! -f "$OUT_PATH/$1.csr" ]; then
  echo -e "${RED}‚úó${NC}"
  exit 1
else
  echo -e "${GREEN}‚úì${NC}"
fi

# Generate certificate
echo -ne "${WHITE}‚¶ø${NC} Generating certificate "
openssl req \
  -newkey rsa:2048 \
  -x509 \
  -nodes \
  -keyout ${OUT_PATH}/$1.key \
  -new \
  -out ${OUT_PATH}/$1.cer \
  -subj "/C=${COUNTRY_CODE}/ST=${STATE}/L=${LOCALITY}/O=${COMPANY}/CN=${COMMON_NAME}" \
  -reqexts SAN \
  -extensions SAN \
  -config \
    <(cat /etc/ssl/openssl.cnf \
    <(printf "[SAN]\nsubjectAltName=DNS:${COMMON_NAME} ")) \
  -sha256 \
  -days 365 \
    > /dev/null 2>&1

if [ ! -f "$OUT_PATH/$1.cer" ]; then
  echo -e "${RED}‚úó${NC}"
  exit 1
else
  echo -e "${GREEN}‚úì${NC}"
fi

echo "Done, cheers!"
echo "üçª"